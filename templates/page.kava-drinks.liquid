<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Custom Kava Drink - WTF | Welcome To Florida</title>
    <style>
      * { box-sizing: border-box; margin: 0; padding: 0; }
      body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f8f9fa; line-height: 1.6; }
      .header { background: #ff6600; color: white; padding: 15px 0; text-align: center; font-size: 24px; font-weight: bold; }
      .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
      .back-link { display: inline-block; color: #ff6600; text-decoration: none; font-weight: bold; font-size: 16px; margin-bottom: 20px; padding: 10px 15px; border: 2px solid #ff6600; border-radius: 5px; transition: all 0.3s ease; }
      .back-link:hover { background: #ff6600; color: white; }
      .product-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 40px; align-items: start; }
      .product-image { width: 100%; max-width: 400px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
      .product-details { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
      .product-title { font-size: 32px; color: #333; margin-bottom: 10px; font-weight: bold; }
      .product-price { font-size: 24px; color: #ff6600; font-weight: bold; margin-bottom: 15px; }
      .product-description { color: #666; margin-bottom: 30px; line-height: 1.6; font-size: 16px; }
      .selection-section { margin: 30px 0; border-bottom: 1px solid #eee; padding-bottom: 20px; }
      .selection-section:last-child { border-bottom: none; }
      .section-title { font-size: 18px; font-weight: bold; color: #333; margin-bottom: 15px; }

      .option-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; }
      .option-button { padding: 15px; border: 3px solid #ddd; border-radius: 8px; text-align: center; background: white; cursor: pointer; transition: all 0.3s ease; color: #333; font-size: 14px; font-family: inherit; min-height: 60px; display: flex; align-items: center; justify-content: center; flex-direction: column; }
      .option-button:hover { border-color: #ff6600; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(255,102,0,0.2); }
      .option-button.selected { background: #ff6600; color: white; border-color: #ff6600; font-weight: bold; }

      .flavor-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px; }
      .flavor-button { padding: 12px 8px; border: 2px solid #ddd; border-radius: 6px; text-align: center; background: white; cursor: pointer; transition: all 0.3s ease; font-size: 13px; color: #333; font-family: inherit; min-height: 45px; display: flex; align-items: center; justify-content: center; }
      .flavor-button:hover { border-color: #28a745; transform: translateY(-1px); }
      .flavor-button.selected { background: #28a745; color: white; border-color: #28a745; font-weight: bold; }

      .quantity-controls { display: flex; align-items: center; gap: 15px; }
      .qty-btn { width: 40px; height: 40px; border: 2px solid #ff6600; background: white; color: #ff6600; border-radius: 50%; cursor: pointer; font-size: 18px; font-weight: bold; font-family: inherit; transition: all 0.3s ease; }
      .qty-btn:hover { background: #ff6600; color: white; transform: scale(1.1); }
      .qty-input { width: 80px; text-align: center; padding: 10px; border: 2px solid #ddd; border-radius: 5px; font-size: 16px; font-family: inherit; }

      .comments-textarea { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 5px; resize: vertical; font-family: inherit; font-size: 14px; line-height: 1.4; }
      .comments-textarea:focus { border-color: #ff6600; outline: none; }

      .add-to-cart-btn { width: 100%; padding: 18px; background: #ff6600; color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 20px; font-family: inherit; transition: all 0.3s ease; }
      .add-to-cart-btn:hover { background: #e55a00; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(255,102,0,0.3); }
      .add-to-cart-btn:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }

      .success-message { background: #d4edda; color: #155724; padding: 15px; border-radius: 5px; margin: 15px 0; border: 1px solid #c3e6cb; display: none; font-size: 14px; line-height: 1.4; }
      .success-message.show { display: block; }

      .cart-status { position: fixed; top: 20px; right: 20px; background: #ff6600; color: white; padding: 10px 15px; border-radius: 25px; font-weight: bold; z-index: 1000; box-shadow: 0 4px 12px rgba(255,102,0,0.3); }

      .info-box { background: #e7f3ff; padding: 15px; border-radius: 8px; margin-bottom: 15px; color: #333; font-size: 14px; line-height: 1.4; }

      @media (max-width: 768px) {
        .product-grid { grid-template-columns: 1fr; }
        .option-grid { grid-template-columns: repeat(2, 1fr); }
        .flavor-grid { grid-template-columns: repeat(2, 1fr); }
        .product-details { padding: 20px; }
      }
    </style>

    <!-- Settings & overrides -->
    <script>
      window.KAVA_VARIANT_ID = {{ page.metafields.custom.kava_variant_id | default: settings.kava_drinks_variant_id | json }};
      window.KAVA_EXTRA_PUMP_PRICE = {{ page.metafields.custom.kava_extra_pump_price | default: settings.kava_extra_pump_price | default: 0.50 | json }};
      window.KAVA_INCLUDED_PUMPS_MEDIUM = {{ page.metafields.custom.kava_included_pumps_medium | default: settings.kava_included_pumps_medium | default: 2 | json }};
      window.KAVA_INCLUDED_PUMPS_LARGE  = {{ page.metafields.custom.kava_included_pumps_large  | default: settings.kava_included_pumps_large  | default: 2 | json }};
    </script>
  </head>
  <body>
    <div class="header">WTF | Welcome To Florida</div>
    <div class="cart-status" id="cart-status">Cart: <span id="cart-count">0</span> items</div>

    <div class="container">
      <a href="/" class="back-link">‚Üê Back to Menu</a>

      <div class="product-grid">
        <div class="product-image-section">
          <img src="{{ 'kava-drinks_150x150.png' | asset_url }}" alt="Custom Kava Drink" class="product-image">
        </div>

        <div class="product-details">
          <h1 class="product-title">Custom Kava Drink</h1>
          <div class="product-price" id="product-price">Starting at $9.00</div>
          <p class="product-description">
            Relax and unwind with our premium kava drinks. Choose your size and flavor combination for the perfect kava
            experience.
          </p>

          <!-- SIZE -->
          <div class="selection-section">
            <h3 class="section-title">‚òï Choose Your Size</h3>
            <div class="option-grid" id="size-options">
              <button type="button" class="option-button" data-size="Medium" data-price="9.00">
                <strong>Medium</strong><br>
                12 oz ‚Äî $9.00
              </button>
              <button type="button" class="option-button" data-size="Large" data-price="15.00">
                <strong>Large</strong><br>
                16 oz ‚Äî $15.00
              </button>
              <button type="button" class="option-button" data-size="Gallon" data-price="100.00">
                <strong>Gallon</strong><br>
                128 oz ‚Äî $100.00
              </button>
            </div>
          </div>

          <!-- FLAVORS -->
          <div class="selection-section">
            <h3 class="section-title">ü•• Choose Your Flavors</h3>
            <div class="info-box">
              <strong>Kava Flavors:</strong> Multiple selections allowed. First <em>included pumps</em> are free by size
              (Medium & Large default to 2). Additional flavors automatically add extra pumps at your configured price.
            </div>
            <div class="flavor-grid" id="flavor-grid">
              <button type="button" class="flavor-button" data-flavor="Lemon">Lemon</button>
              <button type="button" class="flavor-button" data-flavor="Lime">Lime</button>
              <button type="button" class="flavor-button" data-flavor="Orange">Orange</button>
              <button type="button" class="flavor-button" data-flavor="Blood Orange">Blood Orange</button>
              <button type="button" class="flavor-button" data-flavor="Strawberry">Strawberry</button>
              <button type="button" class="flavor-button" data-flavor="Raspberry">Raspberry</button>
              <button type="button" class="flavor-button" data-flavor="Blueberry">Blueberry</button>
              <button type="button" class="flavor-button" data-flavor="Coconut">Coconut</button>
              <button type="button" class="flavor-button" data-flavor="Mango">Mango</button>
              <button type="button" class="flavor-button" data-flavor="Watermelon">Watermelon</button>
              <button type="button" class="flavor-button" data-flavor="Simple Syrup">Simple Syrup</button>
              <button type="button" class="flavor-button" data-flavor="Sour Apple">Sour Apple</button>
              <button type="button" class="flavor-button" data-flavor="Dragon Fruit">Dragon Fruit</button>
              <button type="button" class="flavor-button" data-flavor="Blackberry">Blackberry</button>
              <button type="button" class="flavor-button" data-flavor="S'mores">S'mores</button>
              <button type="button" class="flavor-button" data-flavor="Pumpkin Spice">Pumpkin Spice</button>
              <button type="button" class="flavor-button" data-flavor="Cranberry">Cranberry</button>
              <button type="button" class="flavor-button" data-flavor="Grenadine">Grenadine</button>
              <button type="button" class="flavor-button" data-flavor="Lavender">Lavender</button>
              <button type="button" class="flavor-button" data-flavor="Chocolate">Chocolate</button>
              <button type="button" class="flavor-button" data-flavor="Caramel">Caramel</button>
              <button type="button" class="flavor-button" data-flavor="Maple">Maple</button>
              <button type="button" class="flavor-button" data-flavor="Agave">Agave</button>
              <button type="button" class="flavor-button" data-flavor="Hazelnut">Hazelnut</button>
              <button type="button" class="flavor-button" data-flavor="Rose">Rose</button>
              <button type="button" class="flavor-button" data-flavor="Passion Fruit">Passion Fruit</button>
              <button type="button" class="flavor-button" data-flavor="Hibiscus">Hibiscus</button>
              <button type="button" class="flavor-button" data-flavor="Creamer">Creamer</button>
              <button type="button" class="flavor-button" data-flavor="Oat Milk">Oat Milk</button>
            </div>
            <div id="pump-distribution" class="info-box" style="display:none;"></div>
          </div>

          <!-- COMMENTS -->
          <div class="selection-section">
            <h3 class="section-title">üí¨ Special Requests & Comments</h3>
            <textarea
              id="order-comments"
              class="comments-textarea"
              placeholder="Any special requests or modifications? We'll try to accommodate!"
              rows="3"
            ></textarea>
          </div>

          <!-- QUANTITY -->
          <div class="selection-section">
            <h3 class="section-title">üî¢ Quantity</h3>
            <div class="quantity-controls">
              <button type="button" class="qty-btn" onclick="changeQuantity(-1)">‚àí</button>
              <input type="number" id="quantity" value="1" min="1" max="50" class="qty-input">
              <button type="button" class="qty-btn" onclick="changeQuantity(1)">+</button>
            </div>
          </div>

          <div id="success-message" class="success-message"></div>

          <button type="button" id="add-to-cart-btn" class="add-to-cart-btn" onclick="addToCart()">
            Add to Cart - $9.00
          </button>
        </div>
      </div>
    </div>

    <script>
      // ---------- State ----------
      let selectedSize = null;
      let basePrice = 9.0;
      let selectedFlavors = [];
      let extraPumps = 0;

      const EXTRA_PUMP_PRICE = Number(window.KAVA_EXTRA_PUMP_PRICE || 0.5);
      const INCLUDED_PUMPS = {
        Medium: Number(window.KAVA_INCLUDED_PUMPS_MEDIUM || 2),
        Large: Number(window.KAVA_INCLUDED_PUMPS_LARGE || 2),
        Gallon: 'Custom',
      };

      // ---------- Init ----------
      document.addEventListener('DOMContentLoaded', () => {
        wireSizeButtons();
        wireFlavorButtons();
        // Default to Medium
        const defaultBtn = document.querySelector('#size-options .option-button[data-size="Medium"]');
        if (defaultBtn) defaultBtn.click();
        updateCartCount();
        updatePrice();
      });

      function wireSizeButtons() {
        document.querySelectorAll('#size-options .option-button').forEach((btn) => {
          btn.addEventListener('click', () => {
            document.querySelectorAll('#size-options .option-button').forEach((b) => b.classList.remove('selected'));
            btn.classList.add('selected');

            selectedSize = btn.dataset.size;
            basePrice = parseFloat(btn.dataset.price || '0') || 0;

            autoPumpsFromFlavors();
            renderPumpDistribution();
            updatePrice();
          });
        });
      }

      function wireFlavorButtons() {
        document.querySelectorAll('#flavor-grid .flavor-button').forEach((btn) => {
          btn.addEventListener('click', () => {
            const flavor = btn.dataset.flavor;
            if (!flavor) return;

            if (btn.classList.contains('selected')) {
              btn.classList.remove('selected');
              selectedFlavors = selectedFlavors.filter((f) => f !== flavor);
            } else {
              btn.classList.add('selected');
              selectedFlavors.push(flavor);
            }

            autoPumpsFromFlavors();
            renderPumpDistribution();
            updatePrice();
          });
        });
      }

      // Auto extra-pump logic: if flavors > included pumps for the size, the difference becomes extra pumps.
      function autoPumpsFromFlavors() {
        const included = INCLUDED_PUMPS[selectedSize] ?? 0;
        if (included === 'Custom') {
          // Gallon
          // You can keep this at 0 if gallons are handled in-store.
          extraPumps = selectedFlavors.length; // or 0 ‚Äî your call
          return;
        }
        const count = selectedFlavors.length;
        extraPumps = Math.max(0, count - Number(included || 0));
      }

      function renderPumpDistribution() {
        const box = document.getElementById('pump-distribution');
        if (!selectedSize || selectedFlavors.length === 0) {
          box.style.display = 'none';
          box.innerHTML = '';
          return;
        }
        const included = INCLUDED_PUMPS[selectedSize];
        let html = '<strong>üéØ Pump Distribution</strong><br>';

        if (included === 'Custom') {
          html += 'üìû Gallon orders are custom ‚Äî please discuss pump distribution with staff.';
        } else {
          const totalPumps = Number(included || 0) + Number(extraPumps || 0);
          const per = Math.floor(totalPumps / selectedFlavors.length);
          const rem = totalPumps % selectedFlavors.length;
          selectedFlavors.forEach((f, i) => {
            const pumps = per + (i < rem ? 1 : 0);
            html += `‚Ä¢ ${f}: ${pumps} pump${pumps !== 1 ? 's' : ''}<br>`;
          });
          html += `<em>Included: ${included}, Extra: ${extraPumps} √ó $${EXTRA_PUMP_PRICE.toFixed(2)}</em>`;
        }

        box.innerHTML = html;
        box.style.display = 'block';
      }

      function getTotalPrice() {
        const qty = parseInt(document.getElementById('quantity').value || 1);
        const extras = extraPumps * EXTRA_PUMP_PRICE;
        return (basePrice + extras) * qty;
      }

      function updatePrice() {
        const total = getTotalPrice();
        document.getElementById('product-price').textContent = '$' + total.toFixed(2);
        document.getElementById('add-to-cart-btn').textContent = 'Add to Cart - $' + total.toFixed(2);
      }

      function changeQuantity(delta) {
        const input = document.getElementById('quantity');
        const newVal = Math.max(1, Math.min(50, (parseInt(input.value) || 1) + delta));
        input.value = newVal;
        updatePrice();
      }

      async function updateCartCount() {
        try {
          const res = await fetch('/cart.js', { credentials: 'same-origin' });
          if (res.ok) {
            const cart = await res.json();
            document.getElementById('cart-count').textContent = cart.item_count || 0;
            return;
          }
        } catch (e) {}
        // Fallback to localStorage
        try {
          const local = JSON.parse(localStorage.getItem('wtf-cart') || '[]');
          document.getElementById('cart-count').textContent = local.length;
        } catch {
          document.getElementById('cart-count').textContent = '0';
        }
      }

      function validateSelections() {
        if (!selectedSize) {
          alert('‚ùó Please select a size.');
          return false;
        }
        if (!selectedFlavors || selectedFlavors.length === 0) {
          alert('‚ùó Please select at least one flavor.');
          return false;
        }
        return true;
      }

      function buildPumpDistributionText() {
        if (!selectedSize || selectedFlavors.length === 0) return '';
        const included = INCLUDED_PUMPS[selectedSize];
        if (included === 'Custom') return 'Custom (Gallon) ‚Äî discuss with staff';
        const total = Number(included || 0) + Number(extraPumps || 0);
        const per = Math.floor(total / selectedFlavors.length);
        const rem = total % selectedFlavors.length;
        return selectedFlavors.map((f, i) => `${f}: ${per + (i < rem ? 1 : 0)}`).join(' | ');
      }

      async function addToCart() {
        if (!validateSelections()) return;

        const btn = document.getElementById('add-to-cart-btn');
        const original = btn.textContent;
        btn.textContent = '‚è≥ Adding...';
        btn.disabled = true;

        const variantId = window.KAVA_VARIANT_ID;
        const quantity = parseInt(document.getElementById('quantity').value || 1);
        const comments = (document.getElementById('order-comments').value || '').trim();

        const properties = {
          Size: selectedSize,
          Flavors: selectedFlavors.join(', '),
          'Extra Pumps': extraPumps,
          'Pump Distribution': buildPumpDistributionText(),
          Comments: comments,
        };

        try {
          if (variantId) {
            const body = new URLSearchParams();
            body.set('id', String(variantId));
            body.set('quantity', String(quantity));
            Object.keys(properties).forEach((k) => {
              const v = properties[k];
              if (v !== '' && v !== null && v !== undefined) {
                body.set(`properties[${k}]`, String(v));
              }
            });

            const res = await fetch('/cart/add.js', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
                Accept: 'application/json',
              },
              credentials: 'same-origin',
              body,
            });

            if (!res.ok) {
              let msg = 'Add to cart failed';
              try {
                const data = await res.json();
                msg = data.description || data.message || msg;
              } catch {}
              throw new Error(msg);
            }
          } else {
            // Dev fallback: localStorage cart if no variant configured.
            const order = {
              id: 'kava-' + Date.now() + '-' + Math.random().toString(36).slice(2),
              product: 'Custom Kava Drink',
              ...properties,
              quantity,
              price: getTotalPrice().toFixed(2),
              timestamp: new Date().toISOString(),
              dateAdded: new Date().toLocaleDateString(),
            };
            let cart = [];
            try {
              cart = JSON.parse(localStorage.getItem('wtf-cart') || '[]');
            } catch {
              cart = [];
            }
            cart.push(order);
            localStorage.setItem('wtf-cart', JSON.stringify(cart));
          }

          await updateCartCount();

          const success = document.getElementById('success-message');
          success.innerHTML =
            `‚úÖ <strong>Added to cart!</strong><br>
           ü•• Custom Kava Drink<br>
           üìè Size: ${properties['Size']}<br>
           üçã Flavors: ${properties['Flavors']}<br>` +
            (extraPumps > 0 ? `‚ûï Extra Pumps: ${extraPumps}<br>` : '') +
            (properties['Pump Distribution'] ? `üéØ ${properties['Pump Distribution']}<br>` : '') +
            (comments ? `üí¨ ${comments}<br>` : '') +
            `üî¢ Qty: ${quantity}`;
          success.classList.add('show');
          success.scrollIntoView({ behavior: 'smooth', block: 'center' });

          document.dispatchEvent(new CustomEvent('kava:added', { detail: { variantId, ...properties, quantity } }));
        } catch (err) {
          console.error('Add to cart error:', err);
          alert('‚ùå ' + (err && err.message ? err.message : 'Error adding to cart. Please try again.'));
        } finally {
          setTimeout(() => {
            btn.textContent = original;
            btn.disabled = false;
            document.getElementById('success-message').classList.remove('show');
          }, 4000);
        }
      }
    </script>
  </body>
</html>
