{%- comment -%}
  Kava Drinks – page template
  - Loads shared drink-builder CSS & JS
  - Adds safe focus style to prevent stray orange outline
{%- endcomment -%}

{%- assign css = 'wtf_flavor_system.css' | asset_url -%}
{%- assign js = 'wtf_flavor_system.js' | asset_url -%}

<link rel="preload" as="style" href="{{ css }}">
<link rel="stylesheet" href="{{ css }}">
<script src="{{ js }}" defer></script>

<div class="wtf-page wtf-page--drinks">
  <div class="wtf-container wtf-grid drink-grid">
    <div class="drink-media">
      {%- render 'wtf-product-card', product: all_products['kava-drink-placeholder'] -%}
      {%- comment -%} If you don't have a product card snippet or placeholder product, keep an <img> here {%- endcomment -%}
    </div>

    <div class="drink-builder" data-drink="kava">
      <h1 class="drink-title">Kava Drinks</h1>

      <!-- Sizes -->
      <div class="pill-group" role="group" aria-label="Sizes">
        <button class="pill is-active" data-size="medium" data-price="9">Medium — $9.00</button>
        <button class="pill" data-size="large" data-price="15">Large — $15.00</button>
        <button class="pill" data-size="gallon" data-price="100">Gallon — $100.00</button>
      </div>

      <div class="helper">We’ll split the included pumps evenly across selected flavors.</div>

      <!-- Flavors -->
      <div class="chip-grid" role="group" aria-label="Flavors">
        <button class="chip" data-flavor="Lemon">Lemon</button>
        <button class="chip" data-flavor="Lime">Lime</button>
        <button class="chip" data-flavor="Orange">Orange</button>
        <button class="chip" data-flavor="Strawberry">Strawberry</button>
        <button class="chip" data-flavor="Blueberry">Blueberry</button>
        <button class="chip" data-flavor="Simple Syrup">Simple Syrup</button>
        <button class="chip" data-flavor="Coconut">Coconut</button>
        <button class="chip" data-flavor="Passion Fruit">Passion Fruit</button>
        <button class="chip" data-flavor="Hibiscus">Hibiscus</button>
      </div>

      <!-- Note -->
      <label class="wtf-label" for="drink-note">Any special requests?</label>
      <textarea id="drink-note" class="wtf-input" rows="3" placeholder="Add a note"></textarea>

      <!-- Quantity -->
      <div class="qty-row">
        <button type="button" class="qty-btn" data-dec>−</button>
        <input class="qty-input" type="number" min="1" value="1" aria-label="Quantity">
        <button type="button" class="qty-btn" data-inc>+</button>
      </div>

      <!-- Add to cart -->
      <button class="btn btn--primary add-to-cart" data-sellable="kava-base">
        Add to Cart — <span class="price">$9.00</span>
      </button>
    </div>
  </div>
</div>

<style>
  /* Kill stray bullets/markers & the orange square while keeping visible focus */
  .wtf-page .drink-builder *::marker { content: ''; }
  .wtf-page .drink-builder :focus { outline: none; box-shadow: 0 0 0 3px rgba(255,102,0,.35); border-radius: 10px; }
  /* If some hidden checkbox/radio causes a tiny orange square, hide any visually-hidden toggles */
  .wtf-page .drink-builder input[type="checkbox"].visually-hidden,
  .wtf-page .drink-builder input[type="radio"].visually-hidden { position:absolute; width:1px; height:1px; margin:-1px; clip:rect(0 0 0 0); overflow:hidden; }

  /* Layout helpers (use same vibe as cart) */
  .wtf-container{max-width:1100px;margin:0 auto;padding:clamp(16px,2vw,28px)}
  .drink-grid{display:grid;grid-template-columns:1fr 1.1fr;gap:24px}
  .drink-media{background:#fff;border-radius:16px;box-shadow:0 1px 0 rgba(0,0,0,.06);display:flex;align-items:center;justify-content:center;padding:20px}
  .drink-builder{background:#fff;border-radius:16px;box-shadow:0 1px 0 rgba(0,0,0,.06);padding:18px}
  .drink-title{margin:0 0 12px;font-weight:800}
  .pill-group{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px}
  .pill{height:36px;padding:0 12px;border-radius:999px;border:1px solid #eee;background:#f8f8f8;cursor:pointer}
  .pill.is-active{background:#ff6600;color:#fff;border-color:#ff6600}
  .helper{background:#eef6ff;border:1px solid #e2efff;color:#2d3a4a;font-size:13px;padding:8px 10px;border-radius:10px;margin:10px 0}
  .chip-grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px;margin:10px 0 14px}
  .chip{height:36px;border-radius:10px;border:1px solid #e8e8e8;background:#fff;cursor:pointer}
  .chip.is-selected{background:#111;color:#fff;border-color:#111}
  .wtf-label{font-weight:600;margin:8px 0 6px;display:block}
  .wtf-input{width:100%;border:1px solid #e1e1e1;border-radius:12px;padding:10px}
  .qty-row{display:inline-flex;gap:8px;align-items:center;margin:12px 0}
  .qty-btn{width:36px;height:36px;border:1px solid #e1e1e1;border-radius:10px;background:#fafafa}
  .qty-input{width:56px;height:36px;text-align:center;border:1px solid #e1e1e1;border-radius:10px}
  .btn{display:inline-flex;align-items:center;justify-content:center;height:46px;padding:0 16px;border-radius:12px;border:0;cursor:pointer;font-weight:800}
  .btn--primary{background:#ff6600;color:#fff}
  @media (max-width: 900px){ .drink-grid{grid-template-columns:1fr} }
</style>

<script>
  // Minimal glue so the drawer opens after add
  document.addEventListener('DOMContentLoaded', function(){
    const root = document.querySelector('.drink-builder[data-drink="kava"]');
    if(!root) return;

    const qtyInput = root.querySelector('.qty-input');
    const priceEl = root.querySelector('.price');
    const sizeButtons = root.querySelectorAll('.pill');
    const chipButtons = root.querySelectorAll('.chip');

    function updatePrice(){
      const active = root.querySelector('.pill.is-active');
      const base = Number(active?.dataset.price || 9);
      priceEl.textContent = (base).toLocaleString(undefined,{style:'currency',currency:'USD'});
    }
    sizeButtons.forEach(btn=>{
      btn.addEventListener('click', ()=>{
        sizeButtons.forEach(b=>b.classList.remove('is-active'));
        btn.classList.add('is-active'); updatePrice();
      });
    });
    chipButtons.forEach(btn=>{
      btn.addEventListener('click', ()=> btn.classList.toggle('is-selected'));
    });
    root.querySelector('[data-dec]').addEventListener('click', ()=>{ qtyInput.value = Math.max(1, (Number(qtyInput.value)||1)-1); });
    root.querySelector('[data-inc]').addEventListener('click', ()=>{ qtyInput.value = (Number(qtyInput.value)||1)+1; });

    root.querySelector('.add-to-cart').addEventListener('click', async function(){
      const active = root.querySelector('.pill.is-active');
      const size = active?.dataset.size || 'medium';
      const flavors = Array.from(root.querySelectorAll('.chip.is-selected')).map(x=>x.dataset.flavor);

      // Build properties payload
      const props = { Size: size, Flavors: flavors.join(', '), Note: (root.querySelector('#drink-note').value||'') };

      // You should map "kava-base" to a real variant id server-side; placeholder here uses cart/add by handle.
      await fetch((window.Shopify?.routes?.root||'/')+'cart/add.js', {
        method:'POST', credentials:'same-origin',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ items: [{ id: {{ all_products['kava-drink-base'] | default: all_products['kava-drink-placeholder'] | first_available_variant.id | default: 0 }}, quantity: Number(qtyInput.value)||1, properties: props }] })
      });
      document.dispatchEvent(new CustomEvent('cart:added'));
    });

    updatePrice();
  });
</script>
