{% comment %}
  templates/page.kratom-teas.liquid
  Custom Kratom Tea builder (AJAX cart)
  - One variant ID for the drink (page metafield or theme setting)
  - Medium: 4 included pumps, Large: 6 included pumps, Gallon: 0 (custom)
  - Extra pumps charged at extra_pump_price (default $0.50)
{% endcomment %}

{%- assign tea_variant_id = page.metafields.custom.kratom_variant_id
  | default: settings.kratom_tea_variant_id
  | default: 0
-%}
{%- assign extra_pump_price = page.metafields.custom.extra_pump_price
  | default: settings.kratom_extra_pump_price
  | default: 0.5
-%}
{%- assign price_medium = settings.kratom_price_medium | default: '9.00' -%}
{%- assign price_large = settings.kratom_price_large | default: '15.00' -%}
{%- assign price_gallon = settings.kratom_price_gallon | default: '100.00' -%}

<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Custom Kratom Tea - WTF | Welcome To Florida</title>

    <style>
      :root{
        --primary: {{ settings.color_primary | default: '#ff6600' }};
        --success: {{ settings.color_success | default: '#28a745' }};
        --bg: {{ settings.color_background | default: '#f8f9fa' }};
        --text: {{ settings.color_text | default: '#333333' }};
      }
      *{box-sizing:border-box;margin:0;padding:0}
      body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);line-height:1.6}
      .header{background:var(--primary);color:#fff;padding:15px 0;text-align:center;font-size:24px;font-weight:700}
      .container{max-width:1100px;margin:0 auto;padding:20px}
      .back-link{display:inline-block;color:var(--primary);text-decoration:none;font-weight:700;font-size:16px;margin-bottom:20px;padding:10px 15px;border:2px solid var(--primary);border-radius:6px;transition:.2s}
      .back-link:hover{background:var(--primary);color:#fff}
      .grid{display:grid;grid-template-columns:1fr 1fr;gap:32px;align-items:start}
      .product-image{width:100%;max-width:420px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.08)}
      .panel{background:#fff;padding:24px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.08)}
      .title{font-size:32px;font-weight:800;margin-bottom:6px}
      .price-row{font-size:18px;font-weight:700;color:var(--primary);margin-bottom:10px}
      .desc{color:#666;margin-bottom:18px}
      .section{margin:22px 0;padding-bottom:16px;border-bottom:1px solid #eee}
      .section:last-child{border-bottom:none}
      .section h3{font-size:18px;font-weight:800;margin-bottom:12px}
      .size-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
      .pill, .flavor{padding:14px;border:2px solid #ddd;border-radius:10px;background:#fff;cursor:pointer;transition:.2s;text-align:center;font-size:14px}
      .pill:hover{border-color:var(--primary);transform:translateY(-2px);box-shadow:0 6px 12px rgba(255,102,0,.2)}
      .pill.selected{background:var(--primary);color:#fff;border-color:var(--primary)}
      .strain-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px}
      .flavor-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:8px}
      .flavor:hover{border-color:var(--success);transform:translateY(-1px)}
      .flavor.selected{background:var(--success);color:#fff;border-color:var(--success)}
      .note{background:#e7f3ff;padding:12px;border-radius:8px;margin-bottom:12px;font-size:14px}
      .warn{background:#fff3cd;color:#856404}
      .qty{display:flex;align-items:center;gap:12px}
      .qty .btn{width:40px;height:40px;border:2px solid var(--primary);background:#fff;color:var(--primary);border-radius:50%;font-weight:800;cursor:pointer;transition:.2s}
      .qty .btn:hover{background:var(--primary);color:#fff;transform:scale(1.05)}
      .qty input{width:82px;text-align:center;padding:10px;border:2px solid #ddd;border-radius:8px;font-size:16px}
      textarea{width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;resize:vertical;font-size:14px}
      .btn-primary{width:100%;padding:16px;background:var(--primary);color:#fff;border:none;border-radius:10px;font-size:18px;font-weight:800;cursor:pointer;transition:.2s;margin-top:14px}
      .btn-primary:hover{background:#e55a00;transform:translateY(-2px);box-shadow:0 10px 18px rgba(255,102,0,.25)}
      .btn-primary[disabled]{background:#bbb;cursor:not-allowed;transform:none;box-shadow:none}
      .success{display:none;margin-top:12px;background:#d4edda;color:#155724;border:1px solid #c3e6cb;border-radius:8px;padding:12px;font-size:14px}
      .success.show{display:block}
      .cart-badge{position:fixed;top:16px;right:16px;background:var(--primary);color:#fff;padding:8px 14px;border-radius:999px;font-weight:800;box-shadow:0 10px 18px rgba(255,102,0,.25);z-index:50}
      .hidden{display:none}
      @media(max-width: 820px){.grid{grid-template-columns:1fr}}
    </style>
  </head>
  <body>
    <div class="header">WTF | Welcome To Florida</div>
    <div class="cart-badge">Cart: <span id="cart-count">0</span></div>

    <div class="container">
      <a href="/" class="back-link">‚Üê Back to Menu</a>

      <div class="grid">
        <div>
          <img src="{{ 'kratom_teas_150x150.png' | asset_url }}" alt="Custom Kratom Tea" class="product-image">
        </div>

        <div class="panel">
          <h1 class="title">Custom Kratom Tea</h1>
          <div class="price-row">
            Price: <span id="live-price">${{ price_medium }}</span>
          </div>
          <p class="desc">
            Medium includes <strong>4</strong> pumps, Large includes <strong>6</strong> pumps. Gallon is custom (talk to
            staff). Extra pumps are <strong>${{ extra_pump_price }}</strong> each and are the only thing that changes
            the price.
          </p>

          <!-- SIZE -->
          <div class="section">
            <h3>‚òï Choose Your Size</h3>
            <div class="size-grid" id="size-grid">
              <button type="button" class="pill" data-size="Medium" data-price="{{ price_medium }}">
                Medium<br>
                <small>12 oz ‚Äî ${{ price_medium }}</small>
              </button>
              <button type="button" class="pill" data-size="Large" data-price="{{ price_large }}">
                Large<br>
                <small>16 oz ‚Äî ${{ price_large }}</small>
              </button>
              <button type="button" class="pill" data-size="Gallon" data-price="{{ price_gallon }}">
                Gallon<br>
                <small>128 oz ‚Äî ${{ price_gallon }}</small>
              </button>
            </div>
            <div id="size-note" class="note"></div>
          </div>

          <!-- STRAIN -->
          <div class="section">
            <h3>üåø Choose Your Strain</h3>
            <div class="strain-grid" id="strain-grid">
              <button type="button" class="pill" data-strain="Green">Green</button>
              <button type="button" class="pill" data-strain="Red">Red</button>
              <button type="button" class="pill" data-strain="White">White</button>
              <button type="button" class="pill" data-strain="Yellow">Yellow</button>
              <button type="button" class="pill" data-strain="Mix">Mix (¬Ω & ¬Ω)</button>
            </div>
          </div>

          <!-- FLAVORS -->
          <div class="section">
            <h3>üçã Flavors & Pumps</h3>
            <div class="note">
              Select flavors below. We‚Äôll split the included pumps **and** any extra pumps evenly across selected
              flavors.
            </div>
            <div class="flavor-grid" id="flavor-grid">
              {%- assign flavors = "Lemon,Lime,Orange,Blood Orange,Strawberry,Raspberry,Blueberry,Coconut,Mango,Watermelon,Simple Syrup,Sour Apple,Dragon Fruit,Blackberry,S'mores,Pumpkin Spice,Cranberry,Grenadine,Lavender,Chocolate,Caramel,Maple,Agave,Hazelnut,Rose,Passion Fruit,Hibiscus"
                | split: ','
              -%}
              {%- for f in flavors -%}
                <button type="button" class="flavor" data-flavor="{{ f | escape }}">{{ f }}</button>
              {%- endfor -%}
            </div>
            <div id="pump-distribution" class="note" style="display:none"></div>
          </div>

          <!-- EXTRA PUMPS -->
          <div class="section">
            <h3>
              ‚ûï Additional Pumps (<span id="pump-price">${{ extra_pump_price }}</span> each)
            </h3>
            <div class="qty">
              <button type="button" class="btn" data-extra-delta="-1">‚àí</button>
              <input id="extra-pumps" type="number" min="0" value="0">
              <button type="button" class="btn" data-extra-delta="1">+</button>
              <strong id="extra-pumps-cost" style="margin-left:6px"></strong>
            </div>
            <div id="gallon-warning" class="note warn hidden">
              Gallon has 0 included pumps. Add pumps here if needed and discuss exact distribution with staff.
            </div>
          </div>

          <!-- COMMENTS -->
          <div class="section">
            <h3>üí¨ Special Requests & Comments</h3>
            <textarea id="comments" rows="3" placeholder="Any special requests?"></textarea>
          </div>

          <!-- QTY -->
          <div class="section">
            <h3>üî¢ Quantity</h3>
            <div class="qty">
              <button type="button" class="btn" data-qty-delta="-1">‚àí</button>
              <input id="quantity" type="number" min="1" value="1">
              <button type="button" class="btn" data-qty-delta="1">+</button>
            </div>
          </div>

          <!-- Hidden form (mirrors the payload we send to /cart/add.js) -->
          <form id="wtf-kratom-form" class="hidden">
            <input type="hidden" name="id" value="{{ tea_variant_id }}">
            <input type="number" name="quantity" value="1" min="1">
            <input type="hidden" name="properties[Size]" value="">
            <input type="hidden" name="properties[Strain]" value="">
            <input type="hidden" name="properties[Flavors]" value="">
            <input type="hidden" name="properties[Extra Pumps]" value="0">
            <input type="hidden" name="properties[Pump Distribution]" value="">
            <input type="hidden" name="properties[Comments]" value="">
          </form>

          <button id="add-btn" class="btn-primary">Add to Cart</button>
          <div id="success" class="success"></div>
        </div>
      </div>
    </div>

    <script>
      (function () {
        // ----- Config coming from Liquid -----
        const VARIANT_ID = Number('{{ tea_variant_id }}') || 0;
        const EXTRA_PUMP_PRICE = Number('{{ extra_pump_price }}') || 0.5;

        const SIZE_PRICE = {
          Medium: Number('{{ price_medium }}') || 9,
          Large: Number('{{ price_large }}') || 15,
          Gallon: Number('{{ price_gallon }}') || 100,
        };

        // Included pumps by size (your rule)
        const INCLUDED_BY_SIZE = { Medium: 4, Large: 6, Gallon: 0 };

        // ----- State -----
        let selectedSize = 'Medium';
        let selectedStrain = null;
        let selectedFlavors = new Set();
        let extraPumps = 0;
        let qty = 1;

        // ----- Elements -----
        const $livePrice = document.getElementById('live-price');
        const $extraInput = document.getElementById('extra-pumps');
        const $extraCost = document.getElementById('extra-pumps-cost');
        const $qty = document.getElementById('quantity');
        const $success = document.getElementById('success');
        const $pumpDist = document.getElementById('pump-distribution');
        const $sizeNote = document.getElementById('size-note');
        const $gallonWarn = document.getElementById('gallon-warning');

        // ----- Helpers -----
        const money = (n) => '$' + (Math.round(n * 100) / 100).toFixed(2);
        const includedFor = (size) => INCLUDED_BY_SIZE[size] ?? 0;

        function calcUnitPrice() {
          const base = SIZE_PRICE[selectedSize] || 0;
          return base + extraPumps * EXTRA_PUMP_PRICE;
        }

        function renderSizeNote() {
          const inc = includedFor(selectedSize);
          if (selectedSize === 'Gallon') {
            $sizeNote.innerHTML =
              'Gallon is custom. Included pumps: <strong>0</strong>. Add pumps as needed or discuss with staff.';
            $gallonWarn.classList.remove('hidden');
          } else {
            $sizeNote.innerHTML = `Included pumps: <strong>${inc}</strong> (${selectedSize}).`;
            $gallonWarn.classList.add('hidden');
          }
        }

        function renderPumpDistribution() {
          const flavors = Array.from(selectedFlavors);
          if (!flavors.length) {
            $pumpDist.style.display = 'none';
            return;
          }

          const totalIncluded = includedFor(selectedSize);
          const totalPumps = totalIncluded + extraPumps;

          let html = '<strong>üéØ Pump Distribution</strong><br>';
          if (selectedSize === 'Gallon' && totalPumps === 0) {
            html += '‚Ä¢ Custom distribution ‚Äî please discuss with staff.';
          } else {
            const per = Math.floor(totalPumps / flavors.length);
            const remainder = totalPumps % flavors.length;
            flavors.forEach((f, i) => {
              const pumps = per + (i < remainder ? 1 : 0);
              html += `‚Ä¢ ${f}: ${pumps} pump${pumps !== 1 ? 's' : ''}<br>`;
            });
          }

          $pumpDist.innerHTML = html;
          $pumpDist.style.display = 'block';
        }

        function renderPrice() {
          const unit = calcUnitPrice();
          const total = unit * qty;
          $livePrice.textContent = money(total);
          $extraCost.textContent = extraPumps > 0 ? `(+${money(extraPumps * EXTRA_PUMP_PRICE)})` : '';
          document.getElementById('add-btn').textContent = `Add to Cart ‚Äî ${money(total)}`;
          renderPumpDistribution();
        }

        function validate() {
          if (!VARIANT_ID) {
            alert('This item is not available yet. Please set a Variant ID in theme settings.');
            return false;
          }
          if (!selectedSize) {
            alert('Please choose a size.');
            return false;
          }
          if (!selectedStrain) {
            alert('Please choose a strain.');
            return false;
          }
          if (!selectedFlavors.size) {
            alert('Please choose at least one flavor.');
            return false;
          }
          return true;
        }

        function toastSuccess(msg) {
          $success.innerHTML = `<strong>‚úÖ ${msg}</strong>`;
          $success.classList.add('show');
          setTimeout(() => $success.classList.remove('show'), 3500);
        }

        // ----- Wire up controls -----

        // Sizes
        document.getElementById('size-grid').addEventListener('click', (e) => {
          const btn = e.target.closest('[data-size]');
          if (!btn) return;
          document.querySelectorAll('#size-grid .pill').forEach((b) => b.classList.remove('selected'));
          btn.classList.add('selected');
          selectedSize = btn.dataset.size;
          renderSizeNote();
          renderPrice();
        });
        // Default to Medium
        (document.querySelector('#size-grid [data-size="Medium"]') || {}).click?.();

        // Strains
        document.getElementById('strain-grid').addEventListener('click', (e) => {
          const btn = e.target.closest('[data-strain]');
          if (!btn) return;
          document.querySelectorAll('#strain-grid .pill').forEach((b) => b.classList.remove('selected'));
          btn.classList.add('selected');
          selectedStrain = btn.dataset.strain;
        });

        // Flavors
        document.getElementById('flavor-grid').addEventListener('click', (e) => {
          const btn = e.target.closest('[data-flavor]');
          if (!btn) return;
          const val = btn.dataset.flavor;
          if (btn.classList.contains('selected')) {
            btn.classList.remove('selected');
            selectedFlavors.delete(val);
          } else {
            btn.classList.add('selected');
            selectedFlavors.add(val);
          }
          renderPrice();
        });

        // Quantity
        document.querySelectorAll('[data-qty-delta]').forEach((b) => {
          b.addEventListener('click', () => {
            const d = Number(b.dataset.qtyDelta);
            qty = Math.max(1, (Number($qty.value) || 1) + d);
            $qty.value = qty;
            renderPrice();
          });
        });
        $qty.addEventListener('input', () => {
          qty = Math.max(1, Number($qty.value) || 1);
          $qty.value = qty;
          renderPrice();
        });

        // Extra pumps
        document.querySelectorAll('[data-extra-delta]').forEach((b) => {
          b.addEventListener('click', () => {
            const d = Number(b.dataset.extraDelta);
            extraPumps = Math.max(0, (Number($extraInput.value) || 0) + d);
            $extraInput.value = extraPumps;
            renderPrice();
          });
        });
        $extraInput.addEventListener('input', () => {
          extraPumps = Math.max(0, Number($extraInput.value) || 0);
          $extraInput.value = extraPumps;
          renderPrice();
        });

        // Main Add to Cart
        document.getElementById('add-btn').addEventListener('click', async () => {
          if (!validate()) return;

          const props = {
            Size: selectedSize,
            Strain: selectedStrain || '',
            Flavors: Array.from(selectedFlavors).join(', '),
            'Extra Pumps': String(extraPumps),
            'Pump Distribution': $pumpDist.innerText || '',
            Comments: document.getElementById('comments').value.trim(),
          };

          const payload = { id: VARIANT_ID, quantity: qty, properties: props };

          const btn = document.getElementById('add-btn');
          const old = btn.textContent;
          btn.disabled = true;
          btn.textContent = 'Adding‚Ä¶';

          try {
            await WTF.addToCart(payload);
            toastSuccess('Custom Kratom Tea added to cart!');
          } catch (err) {
            console.error(err);
            alert('‚ùå Error adding to cart.');
          } finally {
            btn.disabled = false;
            btn.textContent = old;
            // refresh price/button text in case qty changed meanwhile
            renderPrice();
          }
        });

        // Sync cart badge
        document.addEventListener('cart:refreshed', (e) => {
          const el = document.getElementById('cart-count');
          if (el && e.detail) el.textContent = e.detail.item_count || 0;
        });
        if (window.WTF && WTF.updateCartCount) WTF.updateCartCount();

        // Initial render
        renderSizeNote();
        renderPrice();
      })();
    </script>
  </body>
</html>
