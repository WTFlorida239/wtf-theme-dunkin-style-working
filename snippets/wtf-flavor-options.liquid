{% comment %}
  Renders the complete WTF ordering interface with size, strain, and flavor selection
  Integrates with wtf_ajax_cart.js for proper variant handling
  Params:
    - title (string) - Product title
    - flavors (Array) - Available flavors
    - option_name (string) - Option name for flavors
    - product (Object) - Shopify product object
{% endcomment %}

{%- assign product = product | default: all_products['custom-kratom-tea'] -%}

<div class="wtf-product-customizer">
  <!-- Product Image and Title -->
  <div class="wtf-product-header">
    <div class="wtf-product-image">
      <img src="{{ 'kratom_tea_drink.png' | asset_url }}" alt="{{ title }}" width="200" height="200" loading="eager">
    </div>
    <div class="wtf-product-info">
      <h2 class="wtf-product-title">{{ title | default: 'Custom Kratom Tea' }}</h2>
      <div class="wtf-product-price" id="wtf-price" data-price>
        {% if product.selected_or_first_available_variant %}
          ${{ product.selected_or_first_available_variant.price | money_without_currency }}
        {% else %}
          $9.00
        {% endif %}
      </div>
      <p class="wtf-product-description">Choose your size, strain, and flavors. We include 2 pumps; extra pumps are $0.50 each.</p>
    </div>
  </div>

  <!-- Size Selection -->
  <div class="wtf-option-group" role="radiogroup" aria-label="Choose Your Size">
    <h3 class="wtf-option-title">‚òï Choose Your Size</h3>
    <div class="wtf-size-grid">
      <button class="wtf-flavor-chip wtf-size-option" type="button" role="radio" data-option="Size" data-value="Medium" aria-checked="false">
        <div class="wtf-size-info">
          <span class="wtf-size-name">Medium</span>
          <span class="wtf-size-details">12 oz ‚Äì $9.00</span>
        </div>
      </button>
      <button class="wtf-flavor-chip wtf-size-option" type="button" role="radio" data-option="Size" data-value="Large" aria-checked="false">
        <div class="wtf-size-info">
          <span class="wtf-size-name">Large</span>
          <span class="wtf-size-details">16 oz ‚Äì $15.00</span>
        </div>
      </button>
      <button class="wtf-flavor-chip wtf-size-option" type="button" role="radio" data-option="Size" data-value="Gallon" aria-checked="false">
        <div class="wtf-size-info">
          <span class="wtf-size-name">Gallon</span>
          <span class="wtf-size-details">128 oz ‚Äì $100.00</span>
        </div>
      </button>
    </div>
  </div>

  <!-- Strain Selection -->
  <div class="wtf-option-group" role="radiogroup" aria-label="Choose Your Strain">
    <h3 class="wtf-option-title">üåø Choose Your Strain</h3>
    <div class="wtf-strain-grid">
      <button class="wtf-flavor-chip wtf-strain-option" type="button" role="radio" data-option="Strain" data-value="Green" aria-checked="false">Green</button>
      <button class="wtf-flavor-chip wtf-strain-option" type="button" role="radio" data-option="Strain" data-value="Red" aria-checked="false">Red</button>
      <button class="wtf-flavor-chip wtf-strain-option" type="button" role="radio" data-option="Strain" data-value="White" aria-checked="false">White</button>
      <button class="wtf-flavor-chip wtf-strain-option" type="button" role="radio" data-option="Strain" data-value="Yellow" aria-checked="false">Yellow</button>
      <button class="wtf-flavor-chip wtf-strain-option" type="button" role="radio" data-option="Strain" data-value="Mix" aria-checked="false">Mix (¬Ω & ¬Ω)</button>
    </div>
  </div>

  <!-- Flavor Selection -->
  <div class="wtf-option-group">
    <h3 class="wtf-option-title">üçã Flavors & Pumps</h3>
    <p class="wtf-flavor-description">Included pumps: <strong>2</strong>. Extra pumps cost <strong>$0.50</strong> each.<br>Add or remove flavors below‚Äîextra pumps will auto-calculate.</p>
    
    <div class="wtf-flavor-grid">
      {% for flavor in flavors %}
        <button class="wtf-flavor-chip" type="button" data-option="Flavor" data-value="{{ flavor | strip }}" aria-checked="false">
          <span class="wtf-flavor-label">{{ flavor }}</span>
        </button>
      {% endfor %}
    </div>
  </div>

  <!-- Additional Pumps -->
  <div class="wtf-option-group">
    <h3 class="wtf-option-title">‚ûï Additional Pumps ($0.50 each)</h3>
    <div class="wtf-quantity-control">
      <button type="button" class="wtf-qty-btn" data-action="decrease">‚àí</button>
      <input type="number" class="wtf-qty-input" value="0" min="0" max="10" data-extra-pumps>
      <button type="button" class="wtf-qty-btn" data-action="increase">+</button>
    </div>
  </div>

  <!-- Special Requests -->
  <div class="wtf-option-group">
    <h3 class="wtf-option-title">üí¨ Special Requests & Comments</h3>
    <textarea class="wtf-special-requests" placeholder="Any special requests?" rows="3"></textarea>
  </div>

  <!-- Quantity -->
  <div class="wtf-option-group">
    <h3 class="wtf-option-title">üî¢ Quantity</h3>
    <div class="wtf-quantity-control">
      <button type="button" class="wtf-qty-btn" data-action="decrease">‚àí</button>
      <input type="number" class="wtf-qty-input" name="quantity" value="1" min="1" max="10">
      <button type="button" class="wtf-qty-btn" data-action="increase">+</button>
    </div>
  </div>
</div>


<style>
  /* WTF Product Customizer Styles */
  .wtf-product-customizer { max-width: 800px; margin: 0 auto; padding: 20px; }
  
  .wtf-product-header { display: flex; gap: 20px; margin-bottom: 30px; align-items: center; }
  .wtf-product-image img { border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
  .wtf-product-info { flex: 1; }
  .wtf-product-title { font-size: 2rem; font-weight: 700; margin: 0 0 10px; color: #333; }
  .wtf-product-price { font-size: 1.5rem; font-weight: 600; color: #ff6600; margin-bottom: 10px; }
  .wtf-product-description { color: #666; line-height: 1.5; }

  .wtf-option-group { margin-bottom: 25px; }
  .wtf-option-title { font-size: 1.25rem; font-weight: 600; margin: 0 0 12px; color: #333; }
  .wtf-flavor-description { color: #666; margin-bottom: 15px; line-height: 1.4; }

  /* Size Grid */
  .wtf-size-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; }
  .wtf-size-option { padding: 15px; text-align: center; }
  .wtf-size-info { display: flex; flex-direction: column; gap: 4px; }
  .wtf-size-name { font-weight: 600; font-size: 1.1rem; }
  .wtf-size-details { font-size: 0.9rem; color: #666; }

  /* Strain Grid */
  .wtf-strain-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; }

  /* Flavor Grid */
  .wtf-flavor-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 8px; }

  /* Flavor Chips */
  .wtf-flavor-chip {
    display: inline-flex; align-items: center; justify-content: center;
    min-height: 44px; padding: 10px 12px; width: 100%;
    border: 2px solid #ddd; border-radius: 25px; background: #fff; color: #333;
    font: inherit; font-weight: 500; cursor: pointer; 
    transition: all 0.2s ease;
  }
  .wtf-flavor-chip:hover { 
    border-color: #ff6600; 
    transform: translateY(-2px); 
    box-shadow: 0 4px 12px rgba(255,102,0,0.2);
  }
  .wtf-flavor-chip:focus-visible { outline: 2px solid #ff6600; outline-offset: 2px; }
  .wtf-flavor-chip.is-selected { 
    border-color: #ff6600; 
    background: #ff6600; 
    color: white;
    box-shadow: 0 4px 12px rgba(255,102,0,0.3);
  }
  .wtf-flavor-label { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

  /* Quantity Controls */
  .wtf-quantity-control { display: flex; align-items: center; gap: 10px; }
  .wtf-qty-btn { 
    width: 40px; height: 40px; border: 2px solid #ddd; border-radius: 50%; 
    background: #fff; font-size: 1.2rem; font-weight: 600; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.2s ease;
  }
  .wtf-qty-btn:hover { border-color: #ff6600; background: #ff6600; color: white; }
  .wtf-qty-input { 
    width: 80px; height: 40px; text-align: center; border: 2px solid #ddd; 
    border-radius: 8px; font-size: 1rem; font-weight: 600;
  }

  /* Special Requests */
  .wtf-special-requests { 
    width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px;
    font-family: inherit; resize: vertical;
  }
  .wtf-special-requests:focus { border-color: #ff6600; outline: none; }

  /* Responsive */
  @media (max-width: 768px) {
    .wtf-product-header { flex-direction: column; text-align: center; }
    .wtf-product-image img { width: 150px; height: 150px; }
    .wtf-size-grid { grid-template-columns: 1fr; }
    .wtf-strain-grid { grid-template-columns: repeat(2, 1fr); }
    .wtf-flavor-grid { grid-template-columns: repeat(2, 1fr); }
  }
</style>

<script>
  (function () {
    'use strict';

    // Handle option selection (size, strain, flavor)
    document.addEventListener('click', function (e) {
      var chip = e.target.closest('.wtf-flavor-chip');
      if (!chip) return;

      var group = chip.closest('.wtf-option-group');
      if (!group) return;

      // For radio groups (size, strain), deselect others
      if (group.getAttribute('role') === 'radiogroup') {
        group.querySelectorAll('.wtf-flavor-chip').forEach(function (b) {
          b.classList.remove('is-selected');
          b.setAttribute('aria-checked', 'false');
        });
      }

      // Toggle selection
      var isSelected = chip.classList.contains('is-selected');
      if (isSelected && group.getAttribute('role') !== 'radiogroup') {
        // Allow deselection for flavors
        chip.classList.remove('is-selected');
        chip.setAttribute('aria-checked', 'false');
      } else {
        chip.classList.add('is-selected');
        chip.setAttribute('aria-checked', 'true');
      }

      // Dispatch events for AJAX cart
      var detail = { option: chip.dataset.option, value: chip.dataset.value };
      document.dispatchEvent(new CustomEvent('wtf:optionSelectedGlobal', { bubbles: true, detail: detail }));
    });

    // Handle quantity controls
    document.addEventListener('click', function (e) {
      if (!e.target.matches('.wtf-qty-btn')) return;

      var input = e.target.parentNode.querySelector('.wtf-qty-input');
      if (!input) return;

      var action = e.target.dataset.action;
      var current = parseInt(input.value) || 0;
      var min = parseInt(input.min) || 0;
      var max = parseInt(input.max) || 999;

      if (action === 'increase' && current < max) {
        input.value = current + 1;
      } else if (action === 'decrease' && current > min) {
        input.value = current - 1;
      }

      // Trigger change event
      input.dispatchEvent(new Event('change', { bubbles: true }));
    });

    // Keyboard support
    document.addEventListener('keydown', function (e) {
      if ((e.key === ' ' || e.key === 'Enter') && e.target.closest('.wtf-flavor-chip')) {
        e.preventDefault();
        e.target.click();
      }
    });

    // Auto-select first size on load
    setTimeout(function() {
      var firstSize = document.querySelector('.wtf-size-option');
      if (firstSize && !document.querySelector('.wtf-size-option.is-selected')) {
        firstSize.click();
      }
    }, 100);

  })();
</script>

