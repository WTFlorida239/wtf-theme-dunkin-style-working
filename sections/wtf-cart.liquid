{% comment %}
  WTF – Cart (polished)
  Mobile-first, clean, accessible. Progressive enhancement: quantity steppers call /cart/change.js,
  then reload to reflect server truth. Works without JS via native Update/Checkout.

  Settings:
  - show_vendor
  - show_sku
  - show_discount_code
  - show_shipping_note
{% endcomment %}

{% schema %}
{
  "name": "Cart (WTF)",
  "settings": [
    { "type": "checkbox", "id": "show_vendor", "label": "Show vendor", "default": false },
    { "type": "checkbox", "id": "show_sku", "label": "Show SKU", "default": false },
    { "type": "checkbox", "id": "show_discount_code", "label": "Show discount prompt", "default": true },
    { "type": "checkbox", "id": "show_shipping_note", "label": "Show order note", "default": true }
  ]
}
{% endschema %}

<section class="wtf-cart" data-section-id="{{ section.id }}">
  <div class="wtf-container">
    <h1 class="wtf-cart__title">Your cart</h1>

    {% if cart.item_count == 0 %}
      <div class="wtf-empty">
        <p>Your cart is empty.</p>
        <a class="btn btn--primary" href="{{ routes.all_products_collection_url }}">Shop products</a>
      </div>
    {% else %}
      <form action="{{ routes.cart_url }}" method="post" novalidate class="wtf-cart__form">
        <ul class="wtf-lines" role="list">
          {% for item in cart.items %}
            <li class="wtf-line" data-line="{{ forloop.index }}">
              <a class="wtf-line__media" href="{{ item.url }}">
                {% if item.image %}
                  <img
                    src="{{ item.image | image_url: width: 220 }}"
                    srcset="{{ item.image | image_url: width: 220 }} 1x, {{ item.image | image_url: width: 440 }} 2x"
                    width="110"
                    height="{{ 110 | divided_by: item.image.aspect_ratio | round }}"
                    alt="{{ item.image.alt | escape }}"
                    loading="lazy"
                  >
                {% else %}
                  <div class="wtf-placeholder" aria-hidden="true"></div>
                {% endif %}
              </a>

              <div class="wtf-line__main">
                <a class="wtf-line__title" href="{{ item.url }}">{{ item.product.title }}</a>

                {% if item.product.has_only_default_variant == false %}
                  <div class="wtf-line__options">
                    {% for option in item.options_with_values %}
                      <span class="wtf-badge">{{ option.name }}: {{ option.value }}</span>
                    {% endfor %}
                  </div>
                {% endif %}

                {% if section.settings.show_vendor and item.product.vendor != blank %}
                  <div class="wtf-meta">by {{ item.product.vendor }}</div>
                {% endif %}
                {% if section.settings.show_sku and item.sku != blank %}
                  <div class="wtf-meta">SKU: {{ item.sku }}</div>
                {% endif %}

                <div class="wtf-line__controls">
                  <div class="wtf-qty">
                    <button type="button" class="wtf-qty__btn" aria-label="Decrease" data-qty-dec>−</button>
                    <input
                      class="wtf-qty__input"
                      type="number"
                      min="0"
                      name="updates[]"
                      value="{{ item.quantity }}"
                      aria-label="Quantity for {{ item.product.title }}"
                    >
                    <button type="button" class="wtf-qty__btn" aria-label="Increase" data-qty-inc>+</button>
                  </div>

                  <button
                    class="wtf-remove"
                    name="updates[]"
                    value="0"
                    formaction="{{ routes.cart_change_url }}?line={{ forloop.index }}"
                    aria-label="Remove {{ item.product.title }}"
                  >
                    Remove
                  </button>
                </div>
              </div>

              <div class="wtf-line__price">
                {% if item.original_price > item.final_price %}
                  <div class="wtf-price">
                    <span class="wtf-price__current">{{ item.final_price | money }}</span>
                    <s class="wtf-price__compare">{{ item.original_price | money }}</s>
                  </div>
                {% else %}
                  <div class="wtf-price">
                    <span class="wtf-price__current">{{ item.final_price | money }}</span>
                  </div>
                {% endif %}
                {% if item.line_level_discount_allocations.size > 0 %}
                  <ul class="wtf-discounts" role="list">
                    {% for alloc in item.line_level_discount_allocations %}
                      <li>{{ alloc.discount_application.title }} (−{{ alloc.amount | money }})</li>
                    {% endfor %}
                  </ul>
                {% endif %}
              </div>
            </li>
          {% endfor %}
        </ul>

        <div class="wtf-cart__bottom">
          <div class="wtf-note">
            {% if section.settings.show_shipping_note %}
              <label for="CartNote" class="wtf-label">Order note</label>
              <textarea
                id="CartNote"
                name="note"
                rows="3"
                placeholder="Add special instructions"
              >{{ cart.note }}</textarea>
            {% endif %}
          </div>

          <div class="wtf-summary">
            {% if section.settings.show_discount_code %}
              <details class="wtf-discount">
                <summary>Have a discount code?</summary>
                <div class="wtf-discount__row">
                  <input
                    type="text"
                    placeholder="Discount code"
                    id="discount"
                    class="wtf-input"
                    name="discount"
                    formnovalidate
                  >
                  <small>Discounts are applied at checkout.</small>
                </div>
              </details>
            {% endif %}

            <div class="wtf-subtotal">
              <span>Subtotal</span>
              <strong>{{ cart.total_price | money }}</strong>
            </div>

            {% if cart.cart_level_discount_applications.size > 0 %}
              <ul class="wtf-discounts" role="list">
                {% for app in cart.cart_level_discount_applications %}
                  <li>{{ app.title }} (−{{ app.total_allocated_amount | money }})</li>
                {% endfor %}
              </ul>
            {% endif %}

            <p class="wtf-fineprint">Taxes and shipping calculated at checkout.</p>

            <div class="wtf-actions">
              <a class="btn btn--secondary" href="{{ routes.all_products_collection_url }}">Continue shopping</a>
              <button class="btn btn--primary" name="checkout" type="submit">Checkout</button>
            </div>
          </div>
        </div>

        <input type="hidden" name="updates[]" value="" aria-hidden="true">
      </form>
    {% endif %}
  </div>
</section>

<style>
  .wtf-container{max-width:1100px;margin:0 auto;padding:clamp(16px,2vw,28px)}
  .wtf-cart__title{font-size:clamp(22px,2.4vw,32px);margin:8px 0 16px;font-weight:700}
  .wtf-empty{text-align:center;padding:40px 0}
  .wtf-lines{display:grid;gap:16px;margin:0;padding:0;list-style:none}
  .wtf-line{display:grid;grid-template-columns:96px 1fr auto;gap:12px;align-items:center;padding:12px;border-radius:14px;background:#fff;box-shadow:0 1px 0 rgba(0,0,0,.06)}
  .wtf-line__media img{display:block;border-radius:12px;background:#f6f6f6}
  .wtf-line__title{display:block;font-weight:600;color:#111;margin-bottom:6px;text-decoration:none}
  .wtf-line__options{display:flex;flex-wrap:wrap;gap:6px;margin:2px 0 8px}
  .wtf-badge{font-size:12px;padding:4px 8px;border-radius:999px;background:#f1f1f1}
  .wtf-meta{font-size:12px;color:#666}
  .wtf-line__controls{display:flex;align-items:center;gap:12px;margin-top:10px}
  .wtf-qty{display:inline-flex;align-items:center;border:1px solid #e1e1e1;border-radius:10px;overflow:hidden}
  .wtf-qty__btn{width:36px;height:36px;border:0;background:#fafafa;cursor:pointer;font-size:18px;line-height:0}
  .wtf-qty__input{width:46px;height:36px;border:0;text-align:center;font-weight:600}
  .wtf-remove{background:none;border:0;color:#888;text-decoration:underline;cursor:pointer}
  .wtf-line__price{text-align:right}
  .wtf-price__current{font-weight:700}
  .wtf-price__compare{color:#888;margin-left:6px}
  .wtf-discounts{margin:6px 0 0;padding-left:0;list-style:none;color:#0a7a3f;font-size:13px}
  .wtf-cart__bottom{display:grid;grid-template-columns:1fr minmax(280px,360px);gap:20px;margin-top:16px}
  .wtf-label{display:block;font-weight:600;margin-bottom:6px}
  .wtf-note textarea{width:100%;border:1px solid #e1e1e1;border-radius:12px;padding:12px;min-height:92px}
  .wtf-summary{background:#fff;border-radius:14px;padding:16px;box-shadow:0 1px 0 rgba(0,0,0,.06);align-self:start}
  .wtf-subtotal{display:flex;justify-content:space-between;align-items:center;font-size:16px;margin:8px 0 6px}
  .wtf-fineprint{color:#666;font-size:12px;margin:8px 0 14px}
  .wtf-actions{display:flex;gap:10px;flex-wrap:wrap}
  .btn{display:inline-flex;align-items:center;justify-content:center;height:46px;padding:0 16px;border-radius:12px;border:0;cursor:pointer;font-weight:700}
  .btn--primary{background:#ff6600;color:#fff}
  .btn--secondary{background:#f1f1f1;color:#111}
  .wtf-discount summary{cursor:pointer;margin-bottom:6px}
  .wtf-discount__row{display:grid;gap:6px}
  .wtf-input{height:42px;border:1px solid #e1e1e1;border-radius:10px;padding:0 12px}
  @media (max-width: 799px){
    .wtf-line{grid-template-columns:78px 1fr auto}
    .wtf-cart__bottom{grid-template-columns:1fr}
    .wtf-actions{flex-direction:column}
    .btn{width:100%}
  }
</style>

<script>
  (function () {
    var cartForm = document.querySelector('.wtf-cart__form');
    if (!cartForm) return;

    cartForm.addEventListener('click', function (e) {
      var dec = e.target.closest('[data-qty-dec]');
      var inc = e.target.closest('[data-qty-inc]');
      if (!dec && !inc) return;

      var line = e.target.closest('.wtf-line');
      if (!line) return;
      var input = line.querySelector('.wtf-qty__input');
      var current = parseInt(input.value || 0, 10);

      if (dec) {
        current = Math.max(0, current - 1);
      }
      if (inc) {
        current = current + 1;
      }
      input.value = current;

      // Sync server, then refresh to reflect discounts/totals accurately
      var index = line.getAttribute('data-line');
      var form = new FormData();
      form.set('line', index);
      form.set('quantity', current);

      fetch((window.Shopify?.routes?.root || '/') + 'cart/change.js', {
        method: 'POST',
        credentials: 'same-origin',
        body: form,
      }).then(function () {
        location.reload();
      });
    });
  })();
</script>
